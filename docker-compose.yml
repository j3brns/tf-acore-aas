# docker-compose.yml — Local development environment
#
# Services:
#   localstack      AWS services mock (DynamoDB, S3, SQS, SSM, Secrets Manager, EventBridge)
#   mock-runtime    Mock AgentCore Runtime (POST /invocations, GET /ping)
#   mock-jwks       Mock JWKS endpoint (issues test JWTs, serves /.well-known/jwks.json)
#
# Usage:
#   make dev        Start all services and seed fixtures
#   make dev-stop   Stop all services
#   make dev-logs   Stream logs from all services

services:
  localstack:
    image: localstack/localstack:latest
    ports:
      - "4566:4566"
    environment:
      - SERVICES=dynamodb,s3,sqs,ssm,secretsmanager,events
      - DEFAULT_REGION=eu-west-2
      - DEBUG=0
    volumes:
      - localstack-data:/var/lib/localstack
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4566/_localstack/health"]
      interval: 5s
      timeout: 3s
      start_period: 15s
      retries: 10

  # Mock AgentCore Runtime — FastAPI on :8765
  # POST /invocations — returns canned SSE streaming response
  # GET  /ping        — returns {"status": "Healthy"}
  # Logs tenant context headers (x-tenant-id, x-app-id, x-tier, etc.)
  mock-runtime:
    build:
      context: .
      dockerfile: tests/mocks/mock-runtime.Dockerfile
    ports:
      - "8765:8765"
    environment:
      - LOG_LEVEL=INFO
    healthcheck:
      test: ["CMD", "python", "-c",
             "import urllib.request; urllib.request.urlopen('http://localhost:8765/ping')"]
      interval: 5s
      timeout: 3s
      start_period: 15s
      retries: 6

  # Mock JWKS endpoint — FastAPI on :8766
  # GET  /.well-known/jwks.json — serves ephemeral RSA public key as JWK Set
  # POST /token                 — issues signed RS256 test JWTs
  # GET  /health                — service health check
  mock-jwks:
    build:
      context: .
      dockerfile: tests/mocks/mock-jwks.Dockerfile
    ports:
      - "8766:8766"
    healthcheck:
      test: ["CMD", "python", "-c",
             "import urllib.request; urllib.request.urlopen('http://localhost:8766/health')"]
      interval: 5s
      timeout: 3s
      start_period: 15s
      retries: 6

volumes:
  localstack-data:
